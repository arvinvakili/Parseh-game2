<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root { --bg: #000; --gold: #ffc107; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: #000 url('images/bg.png') center/cover no-repeat fixed; color: #fff; font-family: sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Ù†ÙˆØ§Ø± ÙˆØ¶Ø¹ÛŒØª Ø­ÛŒØ§ØªÛŒ */
        #status-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 25px;
            background: red; color: white; font-weight: bold; font-size: 12px;
            text-align: center; line-height: 25px; z-index: 999999;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ùˆ Ø³Ø±ÛŒØ¹ */
        header { margin-top: 25px; height: 90px; background: rgba(0,0,0,0.8); padding: 5px 15px; display: flex; flex-direction: column; justify-content: center; }
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .pill { background: #333; padding: 5px 10px; border-radius: 10px; border: 1px solid #555; display: flex; gap: 5px; align-items: center; }
        .pill img { width: 24px; height: 24px; }

        #game { flex: 1; position: relative; }
        .tab { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .tab.active { display: flex; }

        .card { background: rgba(30,30,30,0.95); border: 2px solid var(--gold); border-radius: 15px; padding: 20px; width: 100%; max-width: 350px; text-align: center; margin-bottom: 20px; }
        .icon { width: 100px; height: 100px; object-fit: contain; margin: 10px auto; display: block; }

        button {
            width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: none;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }
        .btn-act { background: #3e2723; color: var(--gold); border: 1px solid #5d4037; }
        .btn-act:active { transform: scale(0.98); }
        .btn-act:disabled { background: #222; color: #555; transform: none; }
        
        .btn-buy { background: #1b5e20; color: white; }

        nav { height: 70px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #333; }
        .nav-btn { background: none; color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-btn.active { color: var(--gold); background: #222; }

        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; border: 1px solid var(--gold); padding: 10px 20px; border-radius: 10px; display: none; z-index: 20000; }
    </style>
</head>
<body>

<div id="status-bar">Ø®Ø·Ø§: Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯ (Reload Ú©Ù†ÛŒØ¯)</div>

<div id="modal">
    <div style="text-align:center; border:2px solid gold; padding:30px; border-radius:20px; background:#111;">
        <h1 style="color:gold">Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</h1>
        <p>Ù†Ø³Ø®Ù‡ Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ú¯</p>
        <button class="btn-act" id="start-btn">ÙˆØ±ÙˆØ¯</button>
    </div>
</div>

<header>
    <div class="row">
        <div class="pill"><img src="images/bread.png" onerror="this.style.display='none'"> <span id="ui-bread">0</span></div>
        <div style="color:gold; font-weight:bold;"><span id="ui-rank">Ø¨Ø±Ø²ÛŒÚ¯Ø±</span></div>
        <div class="pill"><span id="ui-coin">0</span> <img src="images/daric.png" onerror="this.style.display='none'"></div>
    </div>
    <div style="text-align:center; margin-top:5px; font-size:0.8rem; color:#aaa;">Ø´ÛŒØ±: <span id="ui-milk">0</span> | XP: <span id="ui-xp">0</span></div>
</header>

<div id="game">
    <div id="tab-1" class="tab active">
        <div class="card">
            <h2>Ú©Ø´ØªØ²Ø§Ø±</h2>
            <img src="images/shovel.png" class="icon" onerror="this.style.display='none'">
            <div>ØªÙˆØ§Ù†: <span id="ui-dur">3/3</span></div>
            <button id="btn-farm" class="btn-act">Ú©Ø´Øª (Û³Ûµ Ù¾Ù†Ú¯Ø§Ù†) <span id="t-farm"></span></button>
            <button id="btn-glean" class="btn-act" style="background:#004d40; color:white">Ø®ÙˆØ´Ù‡â€ŒÚ†ÛŒÙ†ÛŒ (Ø³Ø±ÛŒØ¹) <span id="t-glean"></span></button>
        </div>
    </div>
    <div id="tab-2" class="tab">
        <div class="card">
            <h2>Ø¢Ù‡Ù†Ú¯Ø±ÛŒ</h2>
            <img src="images/repair.png" class="icon" onerror="this.style.display='none'">
            <button id="btn-rep" class="btn-act">Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ <span id="t-rep"></span></button>
        </div>
    </div>
    <div id="tab-3" class="tab"></div>
    <div id="tab-4" class="tab"><div class="card"><p>Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...</p></div></div>
</div>

<nav>
    <button class="nav-btn active" id="n1">ğŸŒ¾</button>
    <button class="nav-btn" id="n2">ğŸ”¨</button>
    <button class="nav-btn" id="n3">ğŸ</button>
    <button class="nav-btn" id="n4">ğŸ›¡ï¸</button>
</nav>

<div id="toast"></div>

<script>
    // 1. ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¯Ø± Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§
    function log(msg, color='red') {
        const bar = document.getElementById('status-bar');
        bar.innerText = msg;
        bar.style.background = color;
    }

    // 2. Ø¨Ù„ÙˆÚ© Ø§ØµÙ„ÛŒ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
    try {
        log("Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...", "orange");

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        const T_M = 60; // 1 Ø¯Ù‚ÛŒÙ‚Ù‡
        const CFG = {
            farm: 35*T_M, glean: 3, rep: 15*T_M,
            animals: [
                {id:'cow', n:'Ú¯Ø§Ùˆ', c:55, f:5, t:20*T_M, out:3, img:'cow.png'},
                {id:'sheep', n:'Ú¯ÙˆØ³ÙÙ†Ø¯', c:35, f:2, t:25*T_M, out:2, img:'sheep.png'},
                {id:'goat', n:'Ø¨Ø²', c:20, f:3, t:35*T_M, out:0.91, img:'goat.png'}
            ],
            ranks: ["Ø¨Ø±Ø²ÛŒÚ¯Ø±","Ø¯ÙÙ‡Ø¨Ø§Ù†","Ø³Ø±Ø¨Ø§Ø²","Ø³Ø±Ø¯Ø³ØªÙ‡","ÙØ±Ù…Ø§Ù†Ø¯Ù‡","Ø³Ø§ØªØ±Ø§Ù¾","ÙˆØ²ÛŒØ±","Ø´Ø§Ù‡Ù†Ø´Ø§Ù‡"],
            levels: [100,200,330,440,555,710,1000,99999]
        };

        // Ø¯ÛŒØªØ§ÛŒ Ø¨Ø§Ø²ÛŒ
        let G = { 
            bread: 0, coins: 0, milk: 0, dur: 3, lvl: 1, xp: 0, fCount: 0,
            end: { farm:0, glean:0, rep:0, cow:0, sheep:0, goat:0 },
            animals: {}, passive: 0, seen: false
        };

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        const el = (id) => document.getElementById(id);
        const now = () => Math.floor(Date.now()/1000);
        const save = () => { try { localStorage.setItem('PARSEH_V25', JSON.stringify(G)); } catch(e){} };
        const toast = (txt) => { 
            let t = el('toast'); t.innerText = txt; t.style.display='block'; 
            setTimeout(()=>t.style.display='none', 2000); 
        };

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
        try {
            let d = localStorage.getItem('PARSEH_V25');
            if(d) {
                let tmp = JSON.parse(d);
                G = {...G, ...tmp};
                if(!G.animals) G.animals = {};
            }
        } catch(e) { log("Ø®Ø·Ø§ÛŒ Ø­Ø§ÙØ¸Ù‡ (Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…)"); }

        // Ø±Ù†Ø¯Ø±
        function render() {
            el('ui-bread').innerText = G.bread;
            el('ui-coin').innerText = G.coins;
            el('ui-milk').innerText = Math.floor(G.milk);
            el('ui-rank').innerText = CFG.ranks[Math.min(G.lvl,8)-1];
            el('ui-xp').innerText = G.xp;
            el('ui-dur').innerText = G.dur + "/3";

            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            let fb = el('btn-farm');
            if(G.end.farm > 0) { fb.disabled=true; fb.style.opacity=0.5; }
            else { fb.disabled = G.dur<=0; fb.style.opacity=1; }

            let gb = el('btn-glean');
            if(G.end.glean > 0) { gb.disabled=true; gb.style.opacity=0.5; }
            else { gb.disabled=false; gb.style.opacity=1; }

            let rb = el('btn-rep');
            if(G.end.rep > 0) { rb.disabled=true; rb.style.opacity=0.5; }
            else { rb.disabled = G.dur>0; rb.style.opacity=1; }
        }

        function renderHerd() {
            let h = '';
            CFG.animals.forEach(a => {
                let has = G.animals[a.id];
                let busy = G.end[a.id] > 0;
                let lock = G.lvl < (a.id=='cow'?2:a.id=='sheep'?3:5);
                
                h += `<div class="card"><h3>${a.n}</h3><img src="images/${a.img}" class="icon" onerror="this.style.display='none'">`;
                
                if(lock) h += `<div style="color:red">Ù‚ÙÙ„</div>`;
                else if(!has) h += `<button class="btn-act btn-buy" onclick="buy('${a.id}')">Ø®Ø±ÛŒØ¯ (${a.c})</button>`;
                else if(busy) h += `<button class="btn-act" disabled>... <span id="tm-${a.id}"></span></button>`;
                else h += `<button class="btn-act" onclick="milk('${a.id}')">Ø¯ÙˆØ´ÛŒØ¯Ù† (${a.f} Ù†Ø§Ù†)</button>`;
                h += `</div>`;
            });
            h += '<div style="height:50px"></div>';
            el('tab-3').innerHTML = h;
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø¨Ø§Ø²ÛŒ (Ú¯Ù„ÙˆØ¨Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ HTML)
        window.buy = (id) => {
            let a = CFG.animals.find(x=>x.id==id);
            if(G.coins < a.c) { toast("Ù¾ÙˆÙ„ Ú©Ù… Ø§Ø³Øª"); return; }
            G.coins -= a.c; G.animals[id] = true; save(); renderHerd(); render();
        };
        window.milk = (id) => {
            let a = CFG.animals.find(x=>x.id==id);
            if(G.bread < a.f) { toast("Ù†Ø§Ù† Ú©Ù… Ø§Ø³Øª"); return; }
            G.bread -= a.f; G.end[id] = now() + a.t; save(); renderHerd(); render();
        };

        // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        el('start-btn').onclick = () => { el('modal').style.display='none'; G.seen=true; save(); };
        
        el('btn-farm').onclick = () => {
            if(G.dur<=0) return toast("Ø§Ø¨Ø²Ø§Ø± Ø´Ú©Ø³ØªÙ‡");
            G.end.farm = now() + CFG.farm; save(); render();
        };
        el('btn-glean').onclick = () => {
            G.end.glean = now() + CFG.glean; save(); render();
        };
        el('btn-rep').onclick = () => {
            G.end.rep = now() + CFG.rep; save(); render();
        };

        // ØªØ¨â€ŒÙ‡Ø§
        [1,2,3,4].forEach(i => {
            el('n'+i).onclick = () => {
                document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
                el('tab-'+i).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                el('n'+i).classList.add('active');
                if(i===3) renderHerd();
            };
