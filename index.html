<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ --- */
        :root { --bg: #000; --gold: #ffc107; --panel: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        
        body {
            background: #000 url('images/bg.png') center/cover no-repeat fixed;
            color: #fff; font-family: 'Tahoma', serif; margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Ø¯ÛŒØ¨Ø§Ú¯Ø± Ø²Ù†Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨ÙÙ‡Ù…ÛŒÙ… Ù…Ø´Ú©Ù„ Ú†ÛŒØ³Øª) */
        #debug-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 20px;
            background: yellow; color: black; font-size: 10px; z-index: 999999;
            text-align: center; line-height: 20px; font-weight: bold;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø´Ø±ÙˆØ¹ */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-content {
            border: 2px solid var(--gold); padding: 30px; border-radius: 20px;
            text-align: center; max-width: 350px; background: #111;
        }
        .big-btn {
            background: var(--gold); color: #000; border: none; padding: 15px 50px;
            font-size: 1.5rem; font-weight: bold; border-radius: 50px; margin-top: 20px;
            cursor: pointer;
        }

        /* Ù‡Ø¯Ø± */
        header { margin-top: 20px; height: 100px; background: rgba(0,0,0,0.8); padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .res-pill { background: #333; padding: 5px 10px; border-radius: 10px; border: 1px solid #555; display: flex; gap: 5px; }
        .res-pill img { width: 25px; height: 25px; }

        /* Ø¨Ø¯Ù†Ù‡ */
        #game-area { flex: 1; position: relative; }
        .tab { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .tab.active { display: flex; }

        .card { background: rgba(30,30,30,0.9); border: 1px solid var(--gold); border-radius: 15px; padding: 20px; width: 100%; max-width: 350px; text-align: center; margin-bottom: 20px; }
        .main-img { width: 100px; height: 100px; object-fit: contain; margin: 10px auto; }

        /* Ø¯Ú©Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª */
        .act-btn {
            width: 100%; padding: 15px; margin-top: 10px; background: #3e2723; color: var(--gold);
            border: 1px solid #5d4037; border-radius: 10px; font-size: 1.2rem; font-weight: bold;
        }
        .act-btn:disabled { background: #222; color: #555; }

        .timer { font-size: 0.8rem; color: yellow; display: block; margin-top: 5px; }

        /* Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
        nav { height: 70px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #333; }
        .nav-btn { background: none; border: none; color: #666; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-btn.active { color: var(--gold); background: #222; }
        .nav-icon { font-size: 1.5rem; }

        /* Ù¾ÛŒØ§Ù… */
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #222; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 20px; border-radius: 10px; display: none; z-index: 20000;
        }
    </style>
</head>
<body>

<div id="debug-bar">ÙˆØ¶Ø¹ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯...</div>

<div id="start-screen">
    <div class="start-content">
        <h1 style="color:var(--gold)">Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</h1>
        <p>Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
        <button id="btn-enter" class="big-btn">ÙˆØ±ÙˆØ¯</button>
    </div>
</div>

<header>
    <div class="top-row">
        <div class="res-pill"><img src="images/bread.png" onerror="this.style.display='none'"> <span id="val-bread">0</span></div>
        <div style="color:var(--gold); font-weight:bold;"><span id="val-rank">Ø¨Ø±Ø²ÛŒÚ¯Ø±</span></div>
        <div class="res-pill"><span id="val-coin">0</span> <img src="images/daric.png" onerror="this.style.display='none'"></div>
    </div>
    <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:5px;">
        Ø´ÛŒØ±: <span id="val-milk" style="color:#fff">0</span> | Ù¾ÛŒØ´Ø±ÙØª: <span id="val-xp">0%</span>
    </div>
</header>

<div id="game-area">
    <div id="tab-1" class="tab active">
        <div class="card">
            <h2>Ú©Ø´ØªØ²Ø§Ø±</h2>
            <img src="images/shovel.png" class="main-img" onerror="this.style.display='none'">
            <div style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">ØªÙˆØ§Ù†: <span id="val-dur">3/3</span></div>
            
            <button id="btn-farm" class="act-btn">Ú©Ø´Øª (Û³Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡) <span id="t-farm" class="timer"></span></button>
            <button id="btn-glean" class="act-btn" style="background:#004d40; color:#fff; font-size:1rem;">Ø®ÙˆØ´Ù‡â€ŒÚ†ÛŒÙ†ÛŒ (Ø³Ø±ÛŒØ¹) <span id="t-glean" class="timer"></span></button>
        </div>
    </div>

    <div id="tab-2" class="tab">
        <div class="card">
            <h2>Ø¢Ù‡Ù†Ú¯Ø±Ø³Ø±Ø§</h2>
            <img src="images/repair.png" class="main-img" onerror="this.style.display='none'">
            <button id="btn-rep" class="act-btn">Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ <span id="t-rep" class="timer"></span></button>
        </div>
    </div>

    <div id="tab-3" class="tab">
        <div id="herd-list"></div>
    </div>

    <div id="tab-4" class="tab">
        <div class="card"><p>Ø®Ø§Ù†Ø¯Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...</p></div>
    </div>
</div>

<nav>
    <button class="nav-btn active" id="n1"><span class="nav-icon">ğŸŒ¾</span>Ú©Ø´Øª</button>
    <button class="nav-btn" id="n2"><span class="nav-icon">ğŸ”¨</span>Ø¢Ù‡Ù†Ú¯Ø±ÛŒ</button>
    <button class="nav-btn" id="n3"><span class="nav-icon">ğŸ</span>Ú¯Ù„Ù‡</button>
    <button class="nav-btn" id="n4"><span class="nav-icon">ğŸ›¡ï¸</span>Ø®Ø§Ù†Ø¯Ø§Ù†</button>
</nav>

<div id="toast">Ù¾ÛŒØ§Ù…</div>

<script>
    // --- Ø¯ÛŒØ¨Ø§Ú¯Ø± ---
    function debug(msg) {
        document.getElementById('debug-bar').innerText = msg;
        console.log(msg);
    }

    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    const T_MULT = 60; 
    const CFG = {
        farm: 35 * T_MULT, glean: 3, rep: 15 * T_MULT, maxDur: 3,
        animals: [
            {id:'cow', n:'Ú¯Ø§Ùˆ', c:55, f:5, t:20*T_MULT, out:3, img:'cow.png', lvl:2},
            {id:'sheep', n:'Ú¯ÙˆØ³ÙÙ†Ø¯', c:35, f:2, t:25*T_MULT, out:2, img:'sheep.png', lvl:3},
            {id:'goat', n:'Ø¨Ø²', c:20, f:3, t:35*T_MULT, out:0.91, img:'goat.png', lvl:5}
        ],
        ranks: ["Ø¨Ø±Ø²ÛŒÚ¯Ø±", "Ø¯ÙÙ‡Ø¨Ø§Ù†", "Ø³Ø±Ø¨Ø§Ø²", "Ø³Ø±Ø¯Ø³ØªÙ‡", "ÙØ±Ù…Ø§Ù†Ø¯Ù‡", "Ø³Ø§ØªØ±Ø§Ù¾", "ÙˆØ²ÛŒØ±", "Ø´Ø§Ù‡Ù†Ø´Ø§Ù‡"],
        levels: [100, 200, 330, 440, 555, 710, 1000, 99999]
    };

    let G = { 
        bread: 0, coins: 0, milk: 0, dur: 3, lvl: 1, xp: 0, farmC: 0,
        end: { farm: 0, glean: 0, rep: 0, cow: 0, sheep: 0, goat: 0 },
        animals: { cow: false, sheep: false, goat: false },
        passive: 0, seen: false
    };

    // --- Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ (Ù‚Ù„Ø¨ ØªÙ¾Ù†Ø¯Ù‡) ---
    window.onload = function() {
        debug("ÙˆØ¶Ø¹ÛŒØª: Ù„ÙˆØ¯ Ø´Ø¯. Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ù…ØªØµÙ„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯...");
        
        try {
            if(window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
            }
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
            let saved = localStorage.getItem('PARSEH_V24_FINAL');
            if(saved) {
                G = JSON.parse(saved);
                // ÙÛŒÚ©Ø³ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù„
                if(!G.end) G.end = { farm: 0, glean: 0, rep: 0, cow: 0, sheep:
