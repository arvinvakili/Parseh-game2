<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ */
        body { background: #000; color: #fff; font-family: Tahoma, sans-serif; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ */
        .bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: url('images/bg.png') center/cover no-repeat; opacity: 0.6; }

        /* Ø¯ÛŒØ¨Ø§Ú¯Ø± */
        #status-check { position: fixed; top: 0; left: 0; width: 100%; background: red; color: white; text-align: center; font-size: 10px; z-index: 99999; }

        /* Ù‡Ø¯Ø± */
        header { height: 100px; background: rgba(0,0,0,0.8); padding: 10px; border-bottom: 1px solid #333; }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .pill { background: #333; padding: 5px 10px; border-radius: 10px; display: flex; align-items: center; gap: 5px; }
        .pill img { width: 25px; height: 25px; }

        /* Ù…Ø­ØªÙˆØ§ */
        #game-content { flex: 1; position: relative; width: 100%; }
        .page { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: flex; }

        /* Ú©Ø§Ø±Øª */
        .card { background: rgba(30,30,30,0.95); border: 2px solid #ffc107; border-radius: 20px; padding: 20px; width: 100%; max-width: 350px; text-align: center; margin-bottom: 20px; }
        .card img { width: 120px; height: 120px; object-fit: contain; margin: 10px auto; display: block; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        button { width: 100%; padding: 18px; margin-top: 10px; border-radius: 12px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-gold { background: #3e2723; color: #ffc107; border: 1px solid #5d4037; }
        .btn-gold:active { transform: scale(0.95); }
        .btn-gold:disabled { background: #222; color: #555; transform: none; }
        
        .btn-buy { background: #1b5e20; color: white; }

        /* Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
        nav { height: 80px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr); border-top: 1px solid #333; z-index: 100; }
        .nav-item { background: none; color: #777; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item.active { color: #ffc107; background: #222; }
        .icon { font-size: 1.5rem; margin-bottom: 5px; }

        /* Ù…ÙˆØ¯Ø§Ù„ */
        #start-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #ffc107; padding: 10px 20px; border-radius: 10px; display: none; z-index: 6000; color: #ffc107; }
    </style>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ
        var G = { bread:0, coins:0, milk:0, dur:3, lvl:1, xp:0, end:{farm:0, glean:0, rep:0}, animals:{}, seen:false };
        var CFG = { 
            farm: 2100, glean: 3, rep: 900, // 35 min, 3 sec, 15 min
            animals: [
                {id:'cow', n:'Ú¯Ø§Ùˆ', c:55, f:5, t:1200, out:3, img:'cow.png'},
                {id:'sheep', n:'Ú¯ÙˆØ³ÙÙ†Ø¯', c:35, f:2, t:1500, out:2, img:'sheep.png'},
                {id:'goat', n:'Ø¨Ø²', c:20, f:3, t:2100, out:0.91, img:'goat.png'}
            ],
            levels: [100,200,330,440,555,710,1000,99999]
        };

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function el(id) { return document.getElementById(id); }
        function now() { return Math.floor(Date.now()/1000); }
        function save() { localStorage.setItem('PARSEH_V31', JSON.stringify(G)); }
        function msg(txt) {
            var t = el('toast'); t.innerText = txt; t.style.display='block';
            setTimeout(function(){ t.style.display='none'; }, 2000);
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ø¨Ø§Ø²ÛŒ (Ø­ØªÙ…Ø§ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§Ø´Ù†Ø¯) ---
        
        function initGame() {
            try {
                // ØªØ³Øª ØªÙ„Ú¯Ø±Ø§Ù…
                if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
                
                // Ù„ÙˆØ¯ Ø¯ÛŒØªØ§
                var d = localStorage.getItem('PARSEH_V31');
                if(d) {
                    var tmp = JSON.parse(d);
                    G = Object.assign(G, tmp);
                    if(!G.animals) G.animals={};
                }

                if(G.seen) el('start-modal').style.display = 'none';
                
                // Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† Ù…ÙˆÙÙ‚ÛŒØª
                var bar = el('status-check');
                bar.innerText = "âœ… Ø³ÛŒØ³ØªÙ… ÙØ¹Ø§Ù„ Ø´Ø¯ (Ù†Ø³Ø®Ù‡ Û³Û±)";
                bar.style.background = "green";
                setTimeout(function(){ bar.style.display='none'; }, 2000);

                render();
                renderHerd();
                setInterval(loop, 1000);

            } catch(e) {
                alert("Ø®Ø·Ø§ÛŒ Ù…Ø±Ú¯Ø¨Ø§Ø±: " + e);
            }
        }

        function startGame() {
            el('start-modal').style.display = 'none';
            G.seen = true; save(); msg("Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯");
        }

        function switchTab(n) {
            for(var i=1; i<=4; i++) {
                el('page-'+i).classList.remove('active');
                el('nav-'+i).classList.remove('active');
            }
            el('page-'+n).classList.add('active');
            el('nav-'+n).classList.add('active');
            if(n===3) renderHerd();
        }

        function act(type) {
            if(type === 'farm') {
                if(G.dur <= 0) return msg("Ø§Ø¨Ø²Ø§Ø± Ø´Ú©Ø³ØªÙ‡");
                G.end.farm = now() + CFG.farm;
            }
            if(type === 'glean') G.end.glean = now() + CFG.glean;
            if(type === 'rep') G.end.rep = now() + CFG.rep;
            
            save(); render();
        }

        function buy(id) {
            var a = CFG.animals.find(function(x){return x.id==id});
            if(G.coins < a.c) return msg("Ù¾ÙˆÙ„ Ú©Ù… Ø§Ø³Øª");
            G.coins -= a.c; G.animals[id] = true;
            save(); renderHerd(); render();
        }

        function milk(id) {
            var a = CFG.animals.find(function(x){return x.id==id});
            if(G.bread < a.f) return msg("Ù†Ø§Ù† Ú©Ù… Ø§Ø³Øª");
            G.bread -= a.f; 
            if(!G.end[id]) G.end[id]=0;
            G.end[id] = now() + a.t;
            save(); renderHerd(); render();
        }

        // Ø±Ù†Ø¯Ø±
        function render() {
            el('v-bread').innerText = G.bread;
            el('v-coin').innerText = G.coins;
            el('v-milk').innerText = Math.floor(G.milk);
            el('v-dur').innerText = G.dur + "/3";
            el('v-lvl').innerText = G.lvl;

            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            var bf = el('btn-farm');
            if(G.end.farm > 0) { bf.disabled=true; bf.innerText = (G.end.farm - now()) + "s"; }
            else { bf.disabled = G.dur<=0; bf.innerText = "Ú©Ø´Øª (Û³Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡)"; }

            var bg = el('btn-glean');
            if(G.end.glean > 0) { bg.disabled=true; bg.innerText = "..."; }
            else { bg.disabled=false; bg.innerText = "Ø®ÙˆØ´Ù‡â€ŒÚ†ÛŒÙ†ÛŒ (Ø³Ø±ÛŒØ¹)"; }

            var br = el('btn-rep');
            if(G.end.rep > 0) { br.disabled=true; br.innerText = (G.end.rep - now()) + "s"; }
            else { br.disabled = G.dur>0; br.innerText = "Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ"; }
        }

        function renderHerd() {
            var h = '';
            CFG.animals.forEach(function(a){
                var has = G.animals[a.id];
                var busy = (G.end[a.id] || 0) > 0;
                var lock = G.lvl < (a.id=='cow'?2:a.id=='sheep'?3:5);
                
                h += '<div class="card"><h3>'+a.n+'</h3>';
                h += '<img src="images/'+a.img+'" onerror="this.style.display=\'none\'">';
                
                if(lock) h += '<div style="color:red">Ù‚ÙÙ„</div>';
                else if(!has) h += '<button class="btn-gold btn-buy" onclick="buy(\''+a.id+'\')">Ø®Ø±ÛŒØ¯ ('+a.c+')</button>';
                else if(busy) h += '<button class="btn-gold" disabled id="t-'+a.id+'">...</button>';
                else h += '<button class="btn-gold" onclick="milk(\''+a.id+'\')">Ø¯ÙˆØ´ÛŒØ¯Ù† ('+a.f+' Ù†Ø§Ù†)</button>';
                h += '</div>';
            });
            h += '<div style="height:50px"></div>';
            el('herd-box').innerHTML = h;
        }

        function loop() {
            var n = now(); var u = false;
            
            // Ú†Ú© ØªØ§ÛŒÙ…Ø±Ù‡Ø§
            if(G.end.farm > 0 && n >= G.end.farm) {
                G.end.farm = 0; G.bread += 2; G.dur--; 
                // Ù…Ù†Ø·Ù‚ XP
                if(Math.random()<0.3) { G.xp += 5; msg("+2 Ù†Ø§Ù† Ùˆ ØªØ¬Ø±Ø¨Ù‡"); } 
                else msg("+2 Ù†Ø§Ù†");
                
                if(G.xp >= CFG.levels[G.lvl-1]) { G.xp=0; G.lvl++; msg("Ø§Ø±ØªÙ‚Ø§ Ø±ØªØ¨Ù‡!"); }
                u = true;
            }
            if(G.end.glean > 0 && n >= G.end.glean) {
                G.end.glean = 0; G.xp += 1; 
                if(Math.random()<0.3) G.bread++;
                u = true;
            }
            if(G.end.rep > 0 && n >= G.end.rep) {
                G.end.rep = 0; G.dur = 3; msg("ØªØ¹Ù…ÛŒØ± Ø´Ø¯"); u = true;
            }
            
            CFG.animals.forEach(function(a){
                if(G.end[a.id] > 0) {
                    if(n >= G.end[a.id]) { G.end[a.id]=0; G.milk += a.out; msg("Ø´ÛŒØ± Ø¯ÙˆØ´ÛŒØ¯Ù‡ Ø´Ø¯"); u=true; renderHerd(); }
                    else {
                        var e = el('t-'+a.id);
                        if(e) e.innerText = (G.end[a.id]-n) + "s";
                    }
                }
            });

            if(u) { save(); render(); }
            // Ø¢Ù¾Ø¯ÛŒØª ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø§Ú¯Ø± ØªØºÛŒÛŒØ± Ù†Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯ (ÙÙ‚Ø· Ø¨ØµØ±ÛŒ)
            if(G.end.farm > 0) el('btn-farm').innerText = (G.end.farm - n) + "s";
            if(G.end.rep > 0) el('btn-rep').innerText = (G.end.rep - n) + "s";
        }

    </script>
</head>
<body onload="initGame()">

    <div class="bg-layer"></div>
    <div id="status-check">Ø³ÛŒØ³ØªÙ… Ø®Ø§Ù…ÙˆØ´ Ø§Ø³Øª (Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù„ÙˆØ¯ Ù†Ø´Ø¯)</div>

    <div id="start-modal">
        <div class="card">
            <h1 style="color:#ffc107">Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</h1>
            <p>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ÙØ±Ù…Ø§Ù†Ø±ÙˆØ§</p>
            <button class="btn-gold" onclick="startGame()">ÙˆØ±ÙˆØ¯</button>
        </div>
    </div>

    <header>
        <div class="row">
            <div class="pill"><img src="images/bread.png" onerror="this.style.display='none'"> <span id="v-bread">0</span></div>
            <div style="color:#ffc107; font-weight:bold;">Ø±ØªØ¨Ù‡ <span id="v-lvl">1</span></div>
            <div class="pill"><span id="v-coin">0</span> <img src="images/daric.png" onerror="this.style.display='none'"></div>
        </div>
        <div style="text-align:center; margin-top:5px; font-size:0.8rem; color:#aaa;">
            Ø´ÛŒØ±: <span id="v-milk">0</span> | ØªÙˆØ§Ù†: <span id="v-dur">3/3</span>
        </div>
    </header>

    <div id="game-content">
        <div id="page-1" class="page active">
            <div class="card">
                <h2>Ú©Ø´ØªØ²Ø§Ø±</h2>
                <img src="images/shovel.png" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<h1>â›ï¸</h1>')">
                <button id="btn-farm" class="btn-gold" onclick="act('farm')">Ú©Ø´Øª (Û³Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡)</button>
                <button id="btn-glean" class="btn-gold" style="background:#004d40; color:white" onclick="act('glean')">Ø®ÙˆØ´Ù‡â€ŒÚ†ÛŒÙ†ÛŒ</button>
            </div>
        </div>

        <div id="page-2" class="page">
            <div class="card">
                <h2>Ø¢Ù‡Ù†Ú¯Ø±Ø³Ø±Ø§</h2>
                <img src="images/repair.png" onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<h1>ğŸ”¥</h1>')">
                <button id="btn-rep" class="btn-gold" onclick="act('rep')">Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ</button>
            </div>
        </div>

        <div id="page-3" class="page">
            <div id="herd-box" style="width:100%"></div>
        </div>

        <div id="page-4" class="page">
            <div class="card"><p>Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...</p></div>
        </div>
    </div>

    <nav>
        <button id="nav-1" class="nav-item active" onclick="switchTab(1)"><span class="icon">ğŸŒ¾</span>Ú©Ø´Øª</button>
        <button id="nav-2" class="nav-item" onclick="switchTab(2)"><span class="icon">ğŸ”¨</span>Ø¢Ù‡Ù†Ú¯Ø±ÛŒ</button>
        <button id="nav-3" class="nav-item" onclick="switchTab(3)"><span class="icon">ğŸ</span>Ú¯Ù„Ù‡</button>
        <button id="nav-4" class="nav-
