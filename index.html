<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ */
        :root { --bg: #000; --gold: #ffc107; --panel: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none; }
        
        body {
            background: url('images/bg.png') center/cover no-repeat fixed, #000;
            color: #fff; font-family: 'Tahoma', serif; margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Ø¬Ø¹Ø¨Ù‡ Ø®Ø·Ø§ (ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø®Ø±Ø§Ø¨ÛŒ Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯) */
        #error-log {
            display: none; position: fixed; top: 0; left: 0; width: 100%; 
            background: red; color: white; padding: 10px; z-index: 99999; 
            font-size: 12px; text-align: left; direction: ltr;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø´Ø±ÙˆØ¹ */
        #startModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .start-box {
            border: 2px solid var(--gold); padding: 30px; border-radius: 20px;
            background: #111; text-align: center; width: 80%;
        }
        .btn-start {
            background: var(--gold); color: #000; border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px; margin-top: 20px;
        }

        /* Ù‡Ø¯Ø± */
        header { height: 100px; background: rgba(0,0,0,0.8); padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        .res-pill { background: #333; padding: 5px 10px; border-radius: 10px; border: 1px solid #555; display: flex; align-items: center; gap: 5px; }
        .res-pill img { width: 25px; height: 25px; }

        /* Ø¨Ø¯Ù†Ù‡ */
        #main-container { flex: 1; position: relative; }
        .view { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .view.active { display: flex; }

        /* Ú©Ø§Ø±Øª */
        .card {
            background: rgba(20,20,20,0.9); border: 2px solid #444; border-radius: 20px;
            padding: 20px; width: 100%; max-width: 350px; text-align: center; margin-bottom: 20px;
        }
        .main-icon { width: 120px; height: 120px; object-fit: contain; margin: 10px auto; display: block; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn {
            width: 100%; padding: 15px; background: #3e2723; color: var(--gold);
            border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; margin-top: 10px;
        }
        .btn:disabled { background: #333; color: #666; }
        
        .btn-buy { background: #1b5e20; color: #fff; }

        /* Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
        nav {
            height: 70px; background: #111; display: grid; grid-template-columns: repeat(4, 1fr);
            border-top: 2px solid #333;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; }
        .nav-item.active { color: var(--gold); background: #222; }
        .nav-icon { font-size: 1.5rem; }

        /* Ù¾ÛŒØ§Ù… */
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #333; border: 1px solid var(--gold); color: var(--gold);
            padding: 10px 20px; border-radius: 10px; display: none;
        }
    </style>
</head>
<body>

<div id="error-log"></div>

<div id="startModal">
    <div class="start-box">
        <h1 style="color:var(--gold);">Ø§Ù…Ù¾Ø±Ø§Ø·ÙˆØ±ÛŒ Ù¾Ø§Ø±Ø³Ù‡</h1>
        <p>Ø¨Ù‡ Ø¯ÙˆØ±Ø§Ù† Ø´Ú©ÙˆÙ‡ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
        <button class="btn-start" onclick="startGame()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>
</div>

<header>
    <div class="top-row">
        <div class="res-pill"><img src="images/bread.png"> <span id="breadDisplay">0</span></div>
        <div style="color:var(--gold); font-weight:bold;"><span id="rankDisplay">Ø¨Ø±Ø²ÛŒÚ¯Ø±</span></div>
        <div class="res-pill"><span id="daricDisplay">0</span> <img src="images/daric.png"></div>
    </div>
    <div style="text-align:center; font-size:0.8rem; color:#aaa; margin-top:5px;">
        Ù¾ÛŒØ´Ø±ÙØª: <span id="xpText">0</span>
    </div>
</header>

<div id="main-container">
    <div id="view-farm" class="view active">
        <div class="card">
            <h2>Ú©Ø´ØªØ²Ø§Ø±</h2>
            <img src="images/shovel.png" class="main-icon" onerror="this.style.display='none'">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#aaa;">
                <span>ØªÙˆØ§Ù†</span> <span id="durText">3/3</span>
            </div>
            <div style="height:10px; background:#000; width:100%; border-radius:5px;"><div id="durBar" style="height:100%; width:100%; background:orange;"></div></div>
            
            <button id="btn-farm" class="btn" onclick="doFarm()">Ú©Ø´Øª (Û³Ûµ Ù¾Ù†Ú¯Ø§Ù†) <span id="t-farm"></span></button>
            <button class="btn" style="background:#00695c; color:#fff;" onclick="doGlean()">Ø®ÙˆØ´Ù‡â€ŒÚ†ÛŒÙ†ÛŒ (Ø³Ø±ÛŒØ¹) <span id="t-glean"></span></button>
        </div>
    </div>

    <div id="view-smith" class="view">
        <div class="card">
            <h2>Ø¢Ù‡Ù†Ú¯Ø±Ø³Ø±Ø§</h2>
            <img src="images/repair.png" class="main-icon" onerror="this.style.display='none'">
            <button id="btn-repair" class="btn" onclick="doRepair()">Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ <span id="t-repair"></span></button>
        </div>
    </div>

    <div id="view-herd" class="view">
        </div>

    <div id="view-tribe" class="view">
        <div class="card"><p>Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...</p></div>
    </div>
</div>

<nav>
    <div class="nav-item active" id="n-farm" onclick="goTab('farm')"><span class="nav-icon">ğŸŒ¾</span><span>Ú©Ø´Øª</span></div>
    <div class="nav-item" id="n-smith" onclick="goTab('smith')"><span class="nav-icon">ğŸ”¨</span><span>Ø¢Ù‡Ù†Ú¯Ø±ÛŒ</span></div>
    <div class="nav-item" id="n-herd" onclick="goTab('herd')"><span class="nav-icon">ğŸ</span><span>Ú¯Ù„Ù‡</span></div>
    <div class="nav-item" id="n-tribe" onclick="goTab('tribe')"><span class="nav-icon">ğŸ›¡ï¸</span><span>Ø®Ø§Ù†Ø¯Ø§Ù†</span></div>
</nav>

<div id="toast">Ù¾ÛŒØ§Ù…</div>

<script>
    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ ---
    window.onerror = function(msg, url, line) {
        document.getElementById('error-log').style.display = 'block';
        document.getElementById('error-log').innerText = "ERROR: " + msg + " (Line: " + line + ")";
    };

    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
    const TIME_MULT = 60; // 1 Ø¯Ù‚ÛŒÙ‚Ù‡
    const KEY = 'PARSEH_V23_FRESH'; // Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø´
    
    const CFG = {
        farmT: 35 * TIME_MULT, gleanT: 3, repT: 15 * TIME_MULT, maxDur: 3,
        animals: {
            cow: { lvl: 2, cost: 55, feed: 5, t: 2
