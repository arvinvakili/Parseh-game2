<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>امپراطوری پارسه</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            /* پالت رنگی هخامنشی */
            --royal-gold: #ffd700;       /* طلای ناب */
            --royal-blue: rgba(10, 25, 47, 0.7); /* لاجوردی شفاف */
            --border-gold: rgba(255, 215, 0, 0.5);
            --text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            /* تنظیم دقیق پس‌زمینه */
            background: url('images/bg.png') no-repeat center center fixed; 
            background-size: cover;
            background-color: #0f0f0f; /* رنگ پشتیبان اگر عکس لود نشد */
            
            color: #fff;
            /* فونت سریف (دندانه دار) برای حس تاریخی */
            font-family: 'Times New Roman', 'IranNastaliq', serif; 
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* استایل تیترها */
        h1, h2, h3 { 
            font-weight: normal; 
            margin: 0; 
            text-shadow: var(--text-shadow);
            letter-spacing: -1px;
        }

        /* --- سربرگ شفاف --- */
        header {
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .resource img { 
            width: 40px; 
            height: 40px; 
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6)); /* درخشش دور آیکون */
            object-fit: contain;
        }
        
        .resource span { 
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #fff;
            text-shadow: 0 0 5px #000;
        }

        /* --- بدنه اصلی --- */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding-bottom: 100px;
        }

        /* --- کارت‌های شیشه‌ای (مهمترین تغییر برای دیده شدن پس‌زمینه) --- */
        .card {
            background: var(--royal-blue); /* لاجوردی بسیار شفاف */
            border: 1px solid var(--border-gold);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            backdrop-filter: blur(3px); /* تاری کم برای خوانایی */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* تزیین گوشه‌های کارت (حس باستانی) */
        .card::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 10px; pointer-events: none;
        }

        .card h3 { 
            color: var(--royal-gold); 
            font-size: 1.4rem; 
            margin-bottom: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .card-img {
            width: 100px; /* سایز متناسب */
            height: 100px;
            object-fit: contain;
            margin-bottom: 15px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.8));
        }

        /* نوار وضعیت */
        .status-row { 
            display: flex; justify-content: space-between; 
            font-size: 0.9rem; color: #ccc; margin-bottom: 8px; 
        }
        .bar-bg { 
            background: rgba(0,0,0,0.6); 
            height: 8px; border-radius: 4px; overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        .bar-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #daa520, #ffd700); /* طلایی */
            width: 100%; transition: width 0.3s; 
            box-shadow: 0 0 10px #ffd700;
        }

        /* --- دکمه‌های سلطنتی --- */
        .btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            background: linear-gradient(180deg, rgba(20,20,20,0.9) 0%, rgba(50,50,50,0.9) 100%);
            border: 1px solid var(--royal-gold);
            border-radius: 8px;
            color: var(--royal-gold);
            font-family: serif;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.98); background: rgba(0,0,0,0.8); }
        
        .btn:disabled { 
            border-color: #555; color: #777; 
            background: rgba(0,0,0,0.5); cursor: not-allowed;
        }

        /* افکت درخشش روی دکمه */
        .btn::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,215,0,0.1), transparent);
            transform: rotate(45deg); animation: shine 3s infinite;
        }
        @keyframes shine { 0% {left: -100%;} 100% {left: 100%;} }

        /* تایمر */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            align-items: center; justify-content: center;
            color: #fff; font-size: 1.3rem;
            z-index: 2;
        }
        .btn.loading .overlay { display: flex; }

        /* --- پیام‌ها (Toast) --- */
        #toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9); border: 1px solid var(--royal-gold);
            color: var(--royal-gold); padding: 12px 30px; border-radius: 4px;
            font-size: 1rem; opacity: 0; transition: opacity 0.3s; z-index: 200; 
            width: max-content; text-align: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        #toast.show { opacity: 1; top: 50px; }

        /* --- مودال شروع --- */
        #storyModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; padding: 40px; text-align: center;
        }
        .story-content {
            border: 2px solid var(--royal-gold);
            padding: 30px;
            border-radius: 20px;
            background: rgba(0,0,0,0.8);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.1);
        }
        .story-text { font-size: 1.1rem; line-height: 1.8; color: #ddd; max-width: 400px; margin: 20px 0; }
        .story-btn { 
            background: var(--royal-gold); color: #000; border: none; 
            padding: 12px 40px; border-radius: 4px; font-weight: bold; font-size: 1.1rem; 
            cursor: pointer; box-shadow: 0 0 15px var(--royal-gold);
        }

    </style>
</head>
<body>

<div id="storyModal">
    <div class="story-content">
        <img src="images/shovel.png" style="width:80px; filter:drop-shadow(0 0 10px gold);" onerror="this.style.display='none'">
        <h1 style="color:var(--royal-gold); margin-top:10px;">امپراطوری پارس</h1>
        <p class="story-text">
            فرزندم، شکوهِ گذشته را بازگردان.<br>
            با این ابزار ساده آغاز کن و تمدنی بزرگ بساز.
        </p>
        <button class="story-btn" onclick="closeStory()">آغازِ امپراطوری</button>
    </div>
</div>

<header>
    <div class="resource">
        <img src="images/bread.png" alt="نان">
        <span id="breadDisplay">0</span>
    </div>
    <div class="resource">
        <span id="daricDisplay" style="color:var(--royal-gold); font-size:1.6rem;">0</span>
        <img src="images/daric.png" alt="دریک">
    </div>
</header>

<main>
    <div class="card">
        <h3>زمین‌های کشاورزی</h3>
        
        <div style="height: 100px; display:flex; justify-content:center; align-items:center;">
             <img src="images/shovel.png" class="card-img" alt="بیل" onerror="this.style.display='none'">
        </div>
        
        <div class="status-row">
            <span>توانِ ابزار</span>
            <span id="durabilityText">3 / 3</span>
        </div>
        <div class="bar-bg">
            <div class="bar-fill" id="durabilityBar"></div>
        </div>

        <button id="farmBtn" class="btn" onclick="startFarming()">
            کشت و برداشت
            <div class="overlay" id="farmTimer">00:00</div>
        </button>
    </div>

    <div class="card">
        <h3>آهنگرسرای سلطنتی</h3>
        <div style="height: 100px; display:flex; justify-content:center; align-items:center;">
            <img src="images/repair.png" class="card-img" alt="آهنگری" onerror="this.style.display='none'">
        </div>
        <button id="repairBtn" class="btn" onclick="startRepair()" disabled>
            بازسازی ابزار
            <div class="overlay" id="repairTimer">00:00</div>
        </button>
    </div>
</main>

<div id="toast">پیام</div>

<script>
    const CONFIG = { farmTime: 5, repairTime: 10, maxDurability: 3, daricChance: 0.05 };
    let state = { bread: 0, daric: 0, durability: 3, storySeen: false, farmEnd: 0, repairEnd: 0, hash: "" };

    function generateHash() { return btoa(state.bread + "-" + state.daric + "-PARS-SECURE"); }

    window.onload = function() {
        if(window.Telegram && window.Telegram.WebApp) { 
            window.Telegram.WebApp.expand(); 
            // هدر را نامرئی می‌کنیم تا پس‌زمینه دیده شود
            window.Telegram.WebApp.setHeaderColor('#000000'); 
        }
        
        const saved = localStorage.getItem('parseh_v5_royal');
        if (saved) {
            try {
                state = JSON.parse(saved);
                if (state.hash && state.hash !== generateHash()) { resetGame(); }
            } catch(e) { resetGame(); }
        }
        
        if (!state.storySeen) document.getElementById('storyModal').style.display = 'flex';
        render(); setInterval(gameLoop, 1000);
    };

    function resetGame() {
        state = { bread: 0, daric: 0, durability: 3, storySeen: false, farmEnd: 0, repairEnd: 0, hash: "" };
        save();
    }

    function save() { 
        state.hash = generateHash(); 
        localStorage.setItem('parseh_v5_royal', JSON.stringify(state)); 
    }
    
    function closeStory() { 
        document.getElementById('storyModal').style.display = 'none';
        state.storySeen = true; showToast("به پارسه خوش آمدید"); save(); 
    }
    
    function startFarming() {
        if (state.durability <= 0) { showToast("ابزار شکسته است"); return; }
        state.farmEnd = Math.floor(Date.now()/1000) + CONFIG.farmTime;
        showToast("در حال کار..."); save(); render();
    }
    
    function claimFarming() {
        state.farmEnd = 0; state.bread += 2; state.durability--;
        let msg = "محصول برداشت شد (+2 نان)";
        if (Math.random() < CONFIG.daricChance) { state.daric++; msg = "دریک زرین یافت شد!"; }
        if (state.durability === 0) msg += " (ابزار شکست)";
        showToast(msg); save(); render();
    }

    function startRepair() {
        state.repairEnd = Math.floor(Date.now()/1000) + CONFIG.repairTime;
        showToast("آهنگر مشغول کار شد..."); save(); render();
    }

    function claimRepair() {
        state.repairEnd = 0; state.durability = CONFIG.maxDurability;
        showToast("ابزار بازسازی شد"); save(); render();
    }

    function showToast(text) {
        const toast = document.getElementById('toast'); toast.innerText = text; toast.classList.add('show');
        if(window.navigator && window.navigator.vibrate) window.navigator.vibrate(30);
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    function gameLoop() {
        const now = Math.floor(Date.now()/1000); let changed = false;
        if (state.farmEnd > 0) { if (now >= state.farmEnd) { claimFarming(); changed = true; } else updateTimer('farmTimer', state.farmEnd - now); }
        if (state.repairEnd > 0) { if (now >= state.repairEnd) { claimRepair(); changed = true; } else updateTimer('repairTimer', state.repairEnd - now); }
        if(changed) render();
    }

    function updateTimer(id, sec) { document.getElementById(id).innerText = sec + " ثانیه"; }

    function render() {
        document.getElementById('breadDisplay').innerText = state.bread;
        document.getElementById('daricDisplay').innerText = state.daric;
        document.getElementById('durabilityText').innerText = `${state.durability} / ${CONFIG.maxDurability}`;
        document.getElementById('durabilityBar').style.width = (state.durability / CONFIG.maxDurability) * 100 + '%';
        const farmBtn = document.getElementById('farmBtn'); const repairBtn = document.getElementById('repairBtn');
        if(state.farmEnd > 0) { farmBtn.classList.add('loading'); farmBtn.disabled = true; } else { farmBtn.classList.remove('loading'); farmBtn.disabled = (state.durability <= 0); }
        if(state.repairEnd > 0) { repairBtn.classList.add('loading'); repairBtn.disabled = true; } else { repairBtn.classList.remove('loading'); repairBtn.disabled = (state.durability > 0); }
    }
</script>
</body>
</html>
